{% extends 'sklad/base.html' %}

{% block title %}Reviziya | Sklad Reviziya{% endblock %}

{% block extra_css %}
<style>
    /* SEARCH SECTION */
    .search-section {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 24px;
        padding: 2rem 2rem 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 20px 60px rgba(99, 102, 241, 0.3);
    }

    .search-title {
        color: #fff;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .search-subtitle {
        color: rgba(255,255,255,0.7);
        font-size: 14px;
        margin-bottom: 1.5rem;
    }

    .search-box {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 1.25rem 1.5rem 1.25rem 3.5rem;
        font-size: 18px;
        border: none;
        border-radius: 16px;
        background: #fff;
        color: #1f2937;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        outline: none;
    }

    .search-input::placeholder {
        color: #9ca3af;
    }

    .search-input-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 20px;
    }

    .search-clear {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: #f3f4f6;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        color: #6b7280;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .search-clear.show {
        display: flex;
    }

    /* SEARCH RESULTS - KATTA VA CHIROYLI */
    .search-results {
        position: absolute;
        top: calc(100% + 12px);
        left: 0;
        right: 0;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 25px 80px rgba(0,0,0,0.2);
        max-height: 70vh;
        overflow: hidden;
        z-index: 1000;
        display: none;
    }

    .search-results.show {
        display: block;
        animation: slideDown 0.25s ease;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
        padding: 1rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
    }

    .results-header span {
        font-weight: 500;
        color: #64748b;
    }

    .results-count {
        background: #6366f1;
        color: #fff;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .results-list {
        max-height: calc(70vh - 60px);
        overflow-y: auto;
    }

    /* HAR BIR NATIJA - KATTA KARTOCHKA */
    .result-item {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .result-item:hover, .result-item.selected {
        background: #f0f9ff;
    }

    .result-item:active {
        background: #e0f2fe;
    }

    .result-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 24px;
        flex-shrink: 0;
    }

    .result-content {
        flex: 1;
        min-width: 0;
    }

    .result-name {
        font-size: 17px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .result-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 14px;
        color: #64748b;
    }

    .result-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .result-meta-item i {
        font-size: 14px;
        color: #94a3b8;
    }

    .result-arrow {
        color: #cbd5e1;
        font-size: 20px;
        transition: all 0.2s;
    }

    .result-item:hover .result-arrow {
        color: #6366f1;
        transform: translateX(4px);
    }

    /* HIGHLIGHT */
    .highlight {
        background: linear-gradient(120deg, #fde047 0%, #facc15 100%);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
        color: #1e293b;
    }

    /* NO RESULTS */
    .no-results {
        padding: 4rem 2rem;
        text-align: center;
    }

    .no-results-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 36px;
        color: #94a3b8;
    }

    .no-results h4 {
        color: #475569;
        margin-bottom: 0.5rem;
    }

    .no-results p {
        color: #94a3b8;
        font-size: 14px;
    }

    /* MODAL */
    .product-modal .modal-content {
        border: none;
        border-radius: 24px;
        overflow: hidden;
    }

    .modal-product-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        padding: 2rem;
        color: #fff;
    }

    .modal-product-header h4 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .modal-product-header p {
        opacity: 0.8;
        margin: 0;
        font-size: 14px;
    }

    .modal-form {
        padding: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 14px;
    }

    .form-group input {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.2s;
    }

    .form-group input:focus {
        border-color: #6366f1;
        outline: none;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .form-group small {
        display: block;
        color: #9ca3af;
        font-size: 12px;
        margin-top: 0.5rem;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }

    .btn-cancel {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        background: #fff;
        border-radius: 12px;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
    }

    .btn-save {
        flex: 2;
        padding: 1rem;
        border: none;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 12px;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    /* RECENT ITEMS */
    .recent-section {
        background: #fff;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .recent-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
    }

    .recent-header h5 {
        font-weight: 600;
        margin: 0;
        color: #1e293b;
    }

    .recent-item {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .recent-item:last-child {
        border-bottom: none;
    }

    .recent-item-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .recent-item-icon {
        width: 44px;
        height: 44px;
        background: #f1f5f9;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 18px;
    }

    .recent-item-name {
        font-weight: 500;
        color: #1e293b;
        margin-bottom: 2px;
    }

    .recent-item-meta {
        font-size: 13px;
        color: #94a3b8;
    }

    .recent-item-qty {
        font-size: 1.5rem;
        font-weight: 700;
        color: #6366f1;
    }

    /* TOAST */
    .toast-msg {
        position: fixed;
        top: 100px;
        right: 24px;
        background: #10b981;
        color: #fff;
        padding: 1rem 1.5rem;
        border-radius: 14px;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        z-index: 9999;
        animation: toastIn 0.3s ease;
    }

    .toast-msg.error {
        background: #ef4444;
        box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
    }

    @keyframes toastIn {
        from { opacity: 0; transform: translateX(100px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Empty state */
    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #94a3b8;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">Reviziya ‚Ññ{{ revision.revision_number }}</h1>
            <p class="page-subtitle">{{ revision.warehouse.name }}</p>
        </div>
        <a href="{% url 'revizor_items' revision.pk %}" class="btn btn-outline-custom">
            <i class="bi bi-list-ul me-2"></i>Obzor revizii
        </a>
    </div>

    <!-- SEARCH -->
    <div class="search-section">
        <div class="search-title">üîç Tovar qidirish</div>
        <div class="search-subtitle">Dori nomini kiriting - natijalar avtomatik chiqadi</div>

        <div class="search-box">
            <i class="bi bi-search search-input-icon"></i>
            <input type="text"
                   id="searchInput"
                   class="search-input"
                   placeholder="Dori nomini yozing..."
                   autocomplete="off">
            <button class="search-clear" id="clearBtn"><i class="bi bi-x-lg"></i></button>

            <!-- RESULTS -->
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- RECENT -->
    <div class="recent-section">
        <div class="recent-header">
            <h5><i class="bi bi-clock-history me-2"></i>Oxirgi kiritilganlar</h5>
            <a href="{% url 'revizor_items' revision.pk %}" class="btn btn-ghost btn-sm">
                Hammasi <i class="bi bi-arrow-right ms-1"></i>
            </a>
        </div>
        <div id="recentList">
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>Hali tovar kiritilmagan</p>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade product-modal" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-product-header">
                <h4 id="modalName">-</h4>
                <p id="modalManufacturer">-</p>
            </div>
            <div class="modal-form">
                <input type="hidden" id="modalProductId">

                <div class="form-group">
                    <label>Seriya</label>
                    <input type="text" id="modalSeries" placeholder="Seriya raqami">
                    <small>Ixtiyoriy</small>
                </div>

                <div class="form-group">
                    <label>Yaroqlilik muddati <span class="text-danger">*</span></label>
                    <input type="date" id="modalExpiry" min="2025-01-01" max="2050-12-31">
                    <small>2025-2050 oralig'ida</small>
                </div>

                <div class="form-group">
                    <label>Soni <span class="text-danger">*</span></label>
                    <input type="number" id="modalQty" min="0.01" step="0.01" placeholder="0">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" data-bs-dismiss="modal">Bekor</button>
                <button class="btn-save" id="saveBtn">
                    <i class="bi bi-check-lg me-2"></i>Saqlash
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const revisionId = {{ revision.pk }};
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const clearBtn = document.getElementById('clearBtn');
const modal = new bootstrap.Modal(document.getElementById('productModal'));

let timeout;
let results = [];
let selectedIdx = -1;

// SEARCH
searchInput.addEventListener('input', function() {
    const q = this.value.trim();

    clearBtn.classList.toggle('show', q.length > 0);

    clearTimeout(timeout);

    if (q.length < 1) {
        searchResults.classList.remove('show');
        return;
    }

    timeout = setTimeout(() => doSearch(q), 150);
});

function doSearch(q) {
    fetch(`/api/products/search/?q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
            results = data.products || [];
            selectedIdx = -1;
            renderResults(q);
        });
}

function renderResults(q) {
    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon"><i class="bi bi-search"></i></div>
                <h4>"${escapeHtml(q)}" topilmadi</h4>
                <p>Boshqa so'z bilan qidirib ko'ring</p>
            </div>
        `;
    } else {
        searchResults.innerHTML = `
            <div class="results-header">
                <span>Natijalar</span>
                <span class="results-count">${results.length} ta</span>
            </div>
            <div class="results-list">
                ${results.map((p, i) => `
                    <div class="result-item" data-idx="${i}">
                        <div class="result-icon"><i class="bi bi-capsule"></i></div>
                        <div class="result-content">
                            <div class="result-name">${highlight(p.name, q)}</div>
                            <div class="result-meta">
                                <span class="result-meta-item"><i class="bi bi-upc"></i>${p.code}</span>
                                ${p.manufacturer ? `<span class="result-meta-item"><i class="bi bi-building"></i>${p.manufacturer}</span>` : ''}
                            </div>
                        </div>
                        <i class="bi bi-chevron-right result-arrow"></i>
                    </div>
                `).join('')}
            </div>
        `;

        // Click events
        searchResults.querySelectorAll('.result-item').forEach(el => {
            el.onclick = () => selectProduct(results[el.dataset.idx]);
        });
    }

    searchResults.classList.add('show');
}

// Keyboard
searchInput.addEventListener('keydown', function(e) {
    const items = searchResults.querySelectorAll('.result-item');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
        updateSelected(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIdx = Math.max(selectedIdx - 1, 0);
        updateSelected(items);
    } else if (e.key === 'Enter' && selectedIdx >= 0) {
        e.preventDefault();
        selectProduct(results[selectedIdx]);
    } else if (e.key === 'Escape') {
        searchResults.classList.remove('show');
    }
});

function updateSelected(items) {
    items.forEach((el, i) => {
        el.classList.toggle('selected', i === selectedIdx);
        if (i === selectedIdx) el.scrollIntoView({ block: 'nearest' });
    });
}

// Clear
clearBtn.onclick = () => {
    searchInput.value = '';
    clearBtn.classList.remove('show');
    searchResults.classList.remove('show');
    searchInput.focus();
};

// Click outside
document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.remove('show');
    }
});

// Select product
function selectProduct(p) {
    document.getElementById('modalProductId').value = p.id;
    document.getElementById('modalName').textContent = p.name;
    document.getElementById('modalManufacturer').textContent = p.manufacturer || 'Noma\'lum';
    document.getElementById('modalSeries').value = '';
    document.getElementById('modalExpiry').value = '';
    document.getElementById('modalQty').value = '';

    searchResults.classList.remove('show');
    searchInput.value = '';
    clearBtn.classList.remove('show');

    modal.show();
    setTimeout(() => document.getElementById('modalSeries').focus(), 300);
}

// Save
document.getElementById('saveBtn').onclick = function() {
    const productId = document.getElementById('modalProductId').value;
    const series = document.getElementById('modalSeries').value.trim();
    const expiry = document.getElementById('modalExpiry').value;
    const qty = document.getElementById('modalQty').value;

    if (!expiry) {
        toast('Muddatni kiriting!', true);
        return;
    }

    const year = parseInt(expiry.split('-')[0]);
    if (year < 2025 || year > 2050) {
        toast('Muddat 2025-2050 oralig\'ida bo\'lsin!', true);
        return;
    }

    if (!qty || parseFloat(qty) <= 0) {
        toast('Sonni kiriting!', true);
        return;
    }

    fetch('/api/items/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            revision_id: revisionId,
            product_id: productId,
            series: series,
            expiry_date: expiry,
            quantity: parseFloat(qty)
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            modal.hide();
            toast(data.message);
            loadRecent();
            setTimeout(() => searchInput.focus(), 300);
        } else {
            toast(data.error || 'Xatolik!', true);
        }
    });
};

// Enter in modal
document.getElementById('productModal').onkeydown = e => {
    if (e.key === 'Enter') document.getElementById('saveBtn').click();
};

// Load recent
function loadRecent() {
    fetch(`{% url 'revizor_items' revision.pk %}?format=json`)
        .then(r => r.json())
        .then(data => {
            if (data.items?.length > 0) {
                document.getElementById('recentList').innerHTML = data.items.slice(0, 5).map(item => `
                    <div class="recent-item">
                        <div class="recent-item-left">
                            <div class="recent-item-icon"><i class="bi bi-capsule"></i></div>
                            <div>
                                <div class="recent-item-name">${item.product_name}</div>
                                <div class="recent-item-meta">${item.series || ''} ${item.expiry_date || ''}</div>
                            </div>
                        </div>
                        <div class="recent-item-qty">${item.quantity}</div>
                    </div>
                `).join('');
            }
        });
}

// Helpers
function escapeHtml(t) {
    return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function highlight(text, q) {
    if (!q) return text;
    const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(re, '<span class="highlight">$1</span>');
}

function toast(msg, isError) {
    document.querySelectorAll('.toast-msg').forEach(t => t.remove());
    const el = document.createElement('div');
    el.className = 'toast-msg' + (isError ? ' error' : '');
    el.innerHTML = `<i class="bi bi-${isError ? 'x' : 'check'}-circle"></i>${msg}`;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
}

// Init
loadRecent();
searchInput.focus();
</script>
{% endblock %}